user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
}

http {
    # Basic Settings
    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # SSL Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Logging Settings
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # GovStack API Configuration
    server {
        server_name govstack-api.think.ke;
        # Increase max upload size for document uploads (adjust as needed)
        client_max_body_size 100M;
        
        location / {
            # Use localhost with the exposed port instead of container IP
            proxy_pass http://localhost:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/govstack-api.think.ke/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/govstack-api.think.ke/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # GovStack Admin Dashboard Configuration - Temporary HTTP only
    server {
        server_name govstack-dashboard.think.ke;
        
        location / {
            proxy_pass http://localhost:3010;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            
            # Next.js specific headers
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/govstack-dashboard.think.ke/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/govstack-dashboard.think.ke/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }

    # GovStack Analytics Module Configuration - Temporary HTTP only
    server {
        server_name govstack-analytics.think.ke;
        
        location / {
            proxy_pass http://localhost:8005;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            
            # FastAPI specific settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/govstack-analytics.think.ke/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/govstack-analytics.think.ke/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }

    # Wadi Configuration - Update this based on your actual Wadi service
    server {
        server_name wadi.sandbox.think.ke;

        location / {
            # You'll need to check what port Wadi is exposed on
            # If it's not in docker-compose.yml, you may need to add it
            proxy_pass http://localhost:8502;  # Update this port as needed
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/wadi.sandbox.think.ke/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/wadi.sandbox.think.ke/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }
    #Thinkbot Configuration
    server {
        server_name thinkbot.sandbox.think.ke;
        location / {
            proxy_pass http://localhost:8505;  # Already using localhost - good!
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }


    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/thinkbot.sandbox.think.ke/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/thinkbot.sandbox.think.ke/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
    # BSCompanion Configuration
    server {
        server_name bscompanion.sandbox.think.ke;

        location / {
            proxy_pass http://localhost:8503;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    
        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/bscompanion.sandbox.think.ke/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/bscompanion.sandbox.think.ke/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }
    #SHE Configuration
    server {
        server_name she.sandbox.think.ke;

        location / {
            # You'll need to check what port Wadi is exposed on
            # If it's not in docker-compose.yml, you may need to add it
            proxy_pass http://localhost:8506;  # Update this port as needed
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
     

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/she.sandbox.think.ke/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/she.sandbox.think.ke/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
    # Business Listing configuration
    server {
        server_name bslisting.sandbox.think.ke;

        location / {
            proxy_pass http://localhost:8504;  # Already using localhost - good!
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/bslisting.sandbox.think.ke/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/bslisting.sandbox.think.ke/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # API Library Configuration
    server {
        server_name api.sandbox.think.ke;
        
        location / {
            # Use localhost with the exposed port instead of container IP
            proxy_pass http://localhost:9443;  # Update this port as needed
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }

        listen 443 ssl;
        ssl_certificate /etc/letsencrypt/live/api.sandbox.think.ke/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.sandbox.think.ke/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    }

    # ODPC API Configuration - Temporary HTTP only (SSL will be added after cert generation)
    server {
        server_name odpc.think.ke;
        
        location / {
            proxy_pass http://localhost:8002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            
            # FastAPI specific settings
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/odpc.think.ke/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/odpc.think.ke/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

    # HTTP to HTTPS redirect for govstack-api.think.ke
    server {
        if ($host = govstack-api.think.ke) {
            return 301 https://$host$request_uri;
        }

        server_name govstack-api.think.ke;
        listen 80;
        return 404;
    }

    # HTTP to HTTPS redirect for api.sandbox.think.ke
    server {
        if ($host = api.sandbox.think.ke) {
            return 301 https://$host$request_uri;
        }

        server_name api.sandbox.think.ke;
        listen 80;
        return 404;
    }

    # HTTP to HTTPS redirect for bscompanion.sandbox.think.ke
    server {
        if ($host = bscompanion.sandbox.think.ke) {
            return 301 https://$host$request_uri;
        }

        server_name bscompanion.sandbox.think.ke;
        listen 80;
        return 404;
    }

    # HTTP to HTTPS redirect for bslisting.sandbox.think.ke
    server {
        if ($host = bslisting.sandbox.think.ke) {
            return 301 https://$host$request_uri;
        }

        listen 80;
        server_name bslisting.sandbox.think.ke;
        return 404;
    }

    # HTTP to HTTPS redirect for wadi.sandbox.think.ke
    server {
        if ($host = wadi.sandbox.think.ke) {
            return 301 https://$host$request_uri;
        }

        server_name wadi.sandbox.think.ke;
        listen 80;
        return 404;
    }

    # NOTE: HTTP to HTTPS redirect for odpc.think.ke will be added by certbot

    server {
        if ($host = govstack-dashboard.think.ke) {
            return 301 https://$host$request_uri;
        } # managed by Certbot

        server_name govstack-dashboard.think.ke;
        listen 80;
        return 404; # managed by Certbot
    }

    server {
        if ($host = govstack-analytics.think.ke) {
            return 301 https://$host$request_uri;
        } # managed by Certbot

        server_name govstack-analytics.think.ke;
        listen 80;
        return 404; # managed by Certbot
    }

    server {
    if ($host = odpc.think.ke) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        server_name odpc.think.ke;
        listen 80;
    return 404; # managed by Certbot


}
    server {
    if ($host = thinkbot.sandbox.think.ke) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        server_name thinkbot.sandbox.think.ke;
    listen 80;
    return 404; # managed by Certbot


}
    server {
    if ($host = she.sandbox.think.ke) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        server_name she.sandbox.think.ke;
    listen 80;
    return 404; # managed by Certbot


}}